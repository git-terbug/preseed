#!/bin/sh -e

mkdir /usr/local/etc/geoportal
mkdir /usr/local/etc/lucene
mkdir /usr/local/etc/lucene/assertion
ls /usr/local/etc > $PS_LOG/geo

adduser geoportal --gecos "" --disabled-password
echo "geoportal:password" | sudo chpasswd
addgroup geoportal sudo
#su geoportal
cd /usr/local/etc/geoportal
wget https://github.com/Esri/geoportal-server/releases/download/v1.2.8/geoportal-1.2.8.zip
unzip geoportal-1.2.8.zip
ls -l >> $PS_LOG/geo

cd '/usr/local/etc/geoportal/Database Scripts'
chown -R postgres:postgres '/usr/local/etc/geoportal/Database Scripts/PostgreSQL'
chmod -R +x '/usr/local/etc/geoportal/Database Scripts/PostgreSQL'
cd '/usr/local/etc/geoportal/Database Scripts/PostgreSQL'
ls -l >> $PS_LOG/geo

dos2unix grants_linuxpg.sh
dos2unix grants_pg.sql
dos2unix create_schema_linuxpg.sh
dos2unix schema_pg.sql

#agregar contraseÃ±a postgres
sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'password';" >> $PS_LOG/geo
sudo su postgres grants_linuxpg.sh localhost 5432 postgres geoportal postgres geoportal 
sudo su postgres create_schema_linuxpg.sh localhost 5432 postgres geoportal
sudo -u postgres psql -c "\dn" >> $PS_LOG/geo
sudo -u postgres psql -c "\dtvs geoportal.*" >> $PS_LOG/geo

cp '/usr/local/etc/geoportal/Web Applications/Geoportal/geoportal.war' /var/lib/tomcat8/webapps
systemctl restart postgresql
systemctl restart tomcat8
mv /var/lib/tomcat8/webapps/geoportal/WEB-INF/classes/gpt/config/gpt.xml /var/lib/tomcat8/webapps/geoportal/WEB-INF/classes/gpt/config/gpt.xml.old
cp ~/scripts/gpt.xml /var/lib/tomcat8/webapps/geoportal/WEB-INF/classes/gpt/config/gpt.xml
chown tomcat8:tomcat8 /var/lib/tomcat8/webapps/geoportal/WEB-INF/classes/gpt/config/gpt.xml

cp ~/scripts/geoportal.xml /etc/tomcat8/Catalina/localhost/geoportal.xml
chown root:tomcat8 /etc/tomcat8/Catalina/localhost/geoportal.xml
#sudo chmod +wx geoportal.xml